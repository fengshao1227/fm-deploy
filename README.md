# FM Deploy - é¡¹ç›®è‡ªåŠ¨åŒ–éƒ¨ç½²ç³»ç»Ÿ

ä¸€ä¸ªåŸºäº Flutter + Node.js çš„ç§»åŠ¨ç«¯é¡¹ç›®è‡ªåŠ¨åŒ–éƒ¨ç½²ç³»ç»Ÿï¼Œæ”¯æŒå‰ç«¯å’Œåç«¯é¡¹ç›®çš„ä¸€é”®éƒ¨ç½²ã€å®æ—¶æ—¥å¿—æŸ¥çœ‹å’Œç‰ˆæœ¬å›æ»šã€‚

## ğŸ¯ é¡¹ç›®ç‰¹æ€§

- âœ… **ç§»åŠ¨ç«¯ç®¡ç†** - Flutterè·¨å¹³å°åº”ç”¨ï¼Œæ”¯æŒiOSå’ŒAndroid
- âœ… **ä¸€é”®éƒ¨ç½²** - ç®€åŒ–çš„éƒ¨ç½²æµç¨‹ï¼Œç‚¹å‡»å³å¯å®Œæˆéƒ¨ç½²
- âœ… **å®æ—¶æ—¥å¿—** - WebSocketå®æ—¶æ¨é€éƒ¨ç½²æ—¥å¿—
- âœ… **å¤šç¯å¢ƒæ”¯æŒ** - æ”¯æŒæµ‹è¯•ã€é¢„å‘å¸ƒã€ç”Ÿäº§ç­‰å¤šä¸ªç¯å¢ƒ
- âœ… **æƒé™ç®¡ç†** - åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶(RBAC)
- âœ… **éƒ¨ç½²å†å²** - å®Œæ•´çš„éƒ¨ç½²è®°å½•å’Œæ—¥å¿—
- âœ… **ç‰ˆæœ¬å›æ»š** - å¿«é€Ÿå›æ»šåˆ°å†å²ç‰ˆæœ¬

## ğŸ“‹ æ”¯æŒçš„é¡¹ç›®

### å‰ç«¯é¡¹ç›®
- **store-mix** - Taroå¤šç«¯åº”ç”¨
- **vendor-web** - Ant Design Proç®¡ç†åå°
- **brand-web** - Ant Design Proå“ç‰Œç®¡ç†ç³»ç»Ÿ

### åç«¯é¡¹ç›®
- **fm-api** - Laravel APIæœåŠ¡
- **bv-fm-ssr** - Laravel SSRæœåŠ¡

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
fm-deploy/
â”œâ”€â”€ backend/          # Node.jsåç«¯æœåŠ¡
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ config/   # é…ç½®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ models/   # æ•°æ®åº“æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ services/ # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ controllers/ # æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ routes/   # è·¯ç”±
â”‚   â”‚   â””â”€â”€ websocket/ # WebSocketæœåŠ¡
â”‚   â””â”€â”€ package.json
â”‚
â”œâ”€â”€ mobile/           # Flutterç§»åŠ¨åº”ç”¨
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ models/   # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ services/ # ä¸šåŠ¡æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ screens/  # é¡µé¢
â”‚   â”‚   â””â”€â”€ widgets/  # ç»„ä»¶
â”‚   â””â”€â”€ pubspec.yaml
â”‚
â””â”€â”€ docs/             # æ–‡æ¡£
    â”œâ”€â”€ API.md
    â””â”€â”€ DEPLOYMENT.md
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

#### åç«¯
- Node.js >= 18.0.0
- PostgreSQL >= 13
- Redis >= 6.0
- npm æˆ– yarn

#### ç§»åŠ¨ç«¯
- Flutter SDK >= 3.16.0
- Dart >= 3.2.0
- Android Studio æˆ– Xcode

### åç«¯å®‰è£…

1. **è¿›å…¥åç«¯ç›®å½•**
   ```bash
   cd fm-deploy/backend
   ```

2. **å®‰è£…ä¾èµ–**
   ```bash
   npm install
   ```

3. **é…ç½®ç¯å¢ƒå˜é‡**
   ```bash
   cp .env.example .env
   # ç¼–è¾‘ .env æ–‡ä»¶ï¼Œé…ç½®æ•°æ®åº“ç­‰ä¿¡æ¯
   ```

4. **åˆ›å»ºæ•°æ®åº“**
   ```bash
   createdb fm_deploy
   ```

5. **è¿è¡Œæ•°æ®åº“è¿ç§»**
   ```bash
   npm run migrate
   ```

6. **å¯åŠ¨å¼€å‘æœåŠ¡å™¨**
   ```bash
   npm run dev
   ```

   æœåŠ¡å™¨å°†è¿è¡Œåœ¨ `http://localhost:3000`

### ç§»åŠ¨ç«¯å®‰è£…

1. **è¿›å…¥ç§»åŠ¨ç«¯ç›®å½•**
   ```bash
   cd fm-deploy/mobile
   ```

2. **å®‰è£…ä¾èµ–**
   ```bash
   flutter pub get
   ```

3. **é…ç½®APIåœ°å€**
   ç¼–è¾‘ `lib/config/constants.dart`ï¼Œè®¾ç½®åç«¯APIåœ°å€

4. **è¿è¡Œåº”ç”¨**
   ```bash
   # iOS
   flutter run -d iphone

   # Android
   flutter run -d android
   ```

## ğŸ“Š æ•°æ®åº“è®¾è®¡

ç³»ç»Ÿä½¿ç”¨PostgreSQLæ•°æ®åº“ï¼Œä¸»è¦è¡¨ç»“æ„ï¼š

- **users** - ç”¨æˆ·è¡¨
- **environments** - ç¯å¢ƒé…ç½®è¡¨(æµ‹è¯•ã€ç”Ÿäº§ç­‰)
- **projects** - é¡¹ç›®è¡¨
- **project_environments** - é¡¹ç›®ç¯å¢ƒå…³è”è¡¨
- **deployments** - éƒ¨ç½²è®°å½•è¡¨
- **deployment_logs** - éƒ¨ç½²æ—¥å¿—è¡¨
- **deployment_snapshots** - éƒ¨ç½²å¿«ç…§è¡¨(ç”¨äºå›æ»š)

è¯¦ç»†è®¾è®¡å‚è§ [æ•°æ®åº“è®¾è®¡æ–‡æ¡£](./docs/DATABASE.md)

## ğŸ” è®¤è¯ä¸æƒé™

ç³»ç»Ÿä½¿ç”¨JWTè¿›è¡Œè®¤è¯ï¼Œæ”¯æŒä¸¤ç§è§’è‰²ï¼š

- **admin** - ç®¡ç†å‘˜ï¼Œæ‹¥æœ‰æ‰€æœ‰æƒé™
- **developer** - å¼€å‘è€…ï¼Œå¯ä»¥æ‰§è¡Œéƒ¨ç½²æ“ä½œ

## ğŸ› ï¸ éƒ¨ç½²æµç¨‹

### å‰ç«¯é¡¹ç›®éƒ¨ç½²æµç¨‹

1. **è¿æ¥æœåŠ¡å™¨** - SSHè¿æ¥åˆ°ç›®æ ‡æœåŠ¡å™¨
2. **æ›´æ–°ä»£ç ** - æ‰§è¡Œ `git pull`
3. **å®‰è£…ä¾èµ–** - æ‰§è¡Œ `npm install`(å¦‚éœ€è¦)
4. **æ„å»ºé¡¹ç›®** - æ‰§è¡Œ `npm run build`
5. **éƒ¨ç½²æ„å»ºäº§ç‰©** - ä¸Šä¼ æˆ–æ›¿æ¢distç›®å½•
6. **åˆ›å»ºå¿«ç…§** - å¤‡ä»½å½“å‰ç‰ˆæœ¬ç”¨äºå›æ»š

### PHPåç«¯é¡¹ç›®éƒ¨ç½²æµç¨‹

1. **è¿æ¥æœåŠ¡å™¨** - SSHè¿æ¥åˆ°ç›®æ ‡æœåŠ¡å™¨
2. **æ›´æ–°ä»£ç ** - æ‰§è¡Œ `git pull`
3. **å®‰è£…ä¾èµ–** - æ‰§è¡Œ `composer install`
4. **æ¸…é™¤ç¼“å­˜** - æ‰§è¡Œ `php artisan cache:clear`
5. **åˆ›å»ºå¿«ç…§** - å¤‡ä»½å½“å‰ç‰ˆæœ¬ç”¨äºå›æ»š

## ğŸ”„ ç‰ˆæœ¬å›æ»š

ç³»ç»Ÿæ”¯æŒå¿«é€Ÿå›æ»šåˆ°å†å²ç‰ˆæœ¬ï¼š

1. æŸ¥çœ‹éƒ¨ç½²å†å²ï¼Œé€‰æ‹©ç›®æ ‡ç‰ˆæœ¬
2. ç‚¹å‡»å›æ»šæŒ‰é’®
3. ç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œå›æ»šæ“ä½œ
4. å®æ—¶æŸ¥çœ‹å›æ»šæ—¥å¿—

## ğŸ“± ç§»åŠ¨ç«¯åŠŸèƒ½

### ä¸»è¦é¡µé¢

1. **ç™»å½•é¡µ** - ç”¨æˆ·è®¤è¯
2. **é¡¹ç›®åˆ—è¡¨** - å±•ç¤ºæ‰€æœ‰å¯éƒ¨ç½²é¡¹ç›®
3. **é¡¹ç›®è¯¦æƒ…** - æŸ¥çœ‹é¡¹ç›®é…ç½®å’Œéƒ¨ç½²å†å²
4. **éƒ¨ç½²æ‰§è¡Œ** - é€‰æ‹©ç¯å¢ƒå¹¶æ‰§è¡Œéƒ¨ç½²
5. **æ—¥å¿—æŸ¥çœ‹** - å®æ—¶æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—
6. **è®¾ç½®é¡µé¢** - ç¯å¢ƒé…ç½®å’Œè´¦æˆ·ç®¡ç†

## ğŸ§ª æµ‹è¯•

### åç«¯æµ‹è¯•
```bash
cd backend
npm test
```

### ç§»åŠ¨ç«¯æµ‹è¯•
```bash
cd mobile
flutter test
```

## ğŸ“ API æ–‡æ¡£

åç«¯APIæ–‡æ¡£è¯·è®¿é—®ï¼š
- å¼€å‘ç¯å¢ƒ: `http://localhost:3000/api/docs`
- ç”Ÿäº§ç¯å¢ƒ: `https://your-domain.com/api/docs`

æˆ–æŸ¥çœ‹ [APIæ–‡æ¡£](./docs/API.md)

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒé…ç½®ç¤ºä¾‹

```env
# åº”ç”¨é…ç½®
NODE_ENV=production
PORT=3000

# JWTé…ç½®
JWT_SECRET=your-secure-secret-key
JWT_EXPIRES_IN=7d

# æ•°æ®åº“é…ç½®
DB_HOST=your-db-host
DB_PORT=5432
DB_USER=your-db-user
DB_PASSWORD=your-db-password
DB_NAME=fm_deploy

# Redisé…ç½®
REDIS_HOST=your-redis-host
REDIS_PORT=6379
```

### é¡¹ç›®ç¯å¢ƒé…ç½®

åœ¨æ•°æ®åº“ä¸­é…ç½®æ¯ä¸ªé¡¹ç›®çš„éƒ¨ç½²å‚æ•°ï¼š

```sql
INSERT INTO project_environments (
  project_id,
  environment_id,
  deploy_path,
  branch,
  pre_deploy_command,
  build_command,
  post_deploy_command
) VALUES (
  1,  -- store-mixé¡¹ç›®
  1,  -- æµ‹è¯•ç¯å¢ƒ
  '/var/www/html/bottegaveneta/ssr-store',
  'master',
  'git pull',
  'npm install && npm run build:h5',
  NULL
);
```

## ğŸ› é—®é¢˜æ’æŸ¥

### å¸¸è§é—®é¢˜

1. **SSHè¿æ¥å¤±è´¥**
   - æ£€æŸ¥SSHå¯†é’¥è·¯å¾„æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤æœåŠ¡å™¨é˜²ç«å¢™è®¾ç½®
   - éªŒè¯SSHç”¨æˆ·æƒé™

2. **éƒ¨ç½²å¤±è´¥**
   - æŸ¥çœ‹å®æ—¶æ—¥å¿—æ‰¾å‡ºé”™è¯¯åŸå› 
   - æ£€æŸ¥æœåŠ¡å™¨ç£ç›˜ç©ºé—´
   - ç¡®è®¤é¡¹ç›®è·¯å¾„æ˜¯å¦å­˜åœ¨

3. **WebSocketè¿æ¥æ–­å¼€**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - ç¡®è®¤åç«¯æœåŠ¡å™¨WebSocketç«¯å£å¼€æ”¾
   - æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ‘¥ è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚

---

**ç‰ˆæœ¬**: 1.0.0
**æœ€åæ›´æ–°**: 2025-01-28
